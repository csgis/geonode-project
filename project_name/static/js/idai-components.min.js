"use strict";var COMPONENTS_GERMAN_LANG="de",COMPONENTS_ENGLISH_LANG="en";angular.module("idai.components",[]),angular.module("idai.components").factory("countries",["$http","language","$q",function(e,t,n){var r=n.defer(),o=COMPONENTS_ENGLISH_LANG,a=null;t.currentLanguage()==COMPONENTS_GERMAN_LANG&&(o=COMPONENTS_GERMAN_LANG),e.get("info/countries.json").then(function(e){a=[],e.data.forEach(function(e){a.push({name:e["name_"+o],iso_2:e.iso_2})}),r.resolve(a)});var i={};return i.getCountriesAsync=function(){return r.promise},i.getCountries=function(){return a},i}]),angular.module("idai.components").directive("idaiCountryPicker",function(){return{restrict:"E",templateUrl:"forms/idai-country-picker.html",scope:{model:"="},controller:["$scope","countries",function(e,t){t.getCountriesAsync().then(function(t){e.countries=t})}]}}),angular.module("idai.components").directive("idaiPicker",function(){return{restrict:"E",scope:{searchUri:"@",resultField:"@",titleField:"@",totalField:"@",queryParam:"@",limitParam:"@",offsetParam:"@",addParams:"=",selectedItem:"="},templateUrl:"forms/idai-picker.html",controller:["$scope","$parse","$uibModal",function(e,t,n){e.openModal=function(){var t=n.open({templateUrl:"picker_modal.html",controller:"PickerModalController",bindToController:!0,size:"lg",scope:e});t.result.then(function(t){e.selectedItem=t})},e.$watch("titleField",function(n){n||(n="title"),e.getTitleField=t(n)})}]}}),angular.module("idai.components").component("idaiSearch",{restrict:"E",templateUrl:"forms/idai-search.html",bindings:{buttonClass:"@"},controller:["$scope","$location","componentsSettings","$http","idaiSearchService",function(e,t,n,r,o){function a(e){var t=JSON.parse(localStorage.getItem(c));t&&(t.reverse(),t.forEach(function(t){e.push({model:t,extra:!0})}))}function i(e,t){var n=JSON.parse(localStorage.getItem(c));null!==n&&n?(n.push(e),n=n.filter(function(e,t){return n.indexOf(e)==t}),n.length>t+1&&n.shift()):n=[e],localStorage.setItem(c,JSON.stringify(n))}var l=3,c="previousSearchQueries";e.placeholder=void 0,e.buttonClass="btn-primary",this.buttonClass&&(e.buttonClass=this.buttonClass),o.register(function(t){e.placeholder=t}.bind(this)),e.$on("$locationChangeStart",function(n,r){r.indexOf("search")==-1&&o.notify(void 0),e.q=t.search().q}),e.search=function(n){var r;r=n?'"'+n.model+'"':e.q,i(r,l),e.q=r,r||(r=""),t.url("/search?q="+r),o.notify(r)},e.selectQueryString=function(e){e.target.select()},e.getSuggestions=function(e){if(n.searchUri)return r.get(n.searchUri+e).then(function(e){if(!e.data.suggestions)return[];var t=e.data.suggestions.map(function(e){return{model:e}});return t?(a(t),t):[]})}}]}),angular.module("idai.components").factory("idaiSearchService",function(){var e=[];return{register:function(t){e.push(t)},notify:function(t){for(var n in e)e[n](t)}}}),angular.module("idai.components").controller("PickerModalController",["$scope","$http","$q","$parse","$uibModalInstance",function(e,t,n,r,o){var a;e.result,e.total=0,e.offset=0,e.limit=10,e.loading=!1,e.preselect=0;var i=function(){if(a&&a.resolve(),e.query){e.loading=!0,a=n.defer(),e.queryParam||(e.queryParam="q"),e.limitParam||(e.limitParam="limit"),e.offsetParam||(e.offsetParam="offset");var o=e.searchUri+"?"+e.queryParam+"="+e.query;o+="&"+e.limitParam+"="+e.limit,o+="&"+e.offsetParam+"="+e.offset,e.addParams&&angular.forEach(e.addParams,function(e,t){o+="&"+t+"="+e}),t.get(o,{timeout:a.promise}).then(function(t){e.resultField||(e.resultField="result");var n=r(e.resultField);0==e.offset?e.result=n(t.data):e.result=e.result.concat(n(t.data)),e.totalField||(e.totalField="total");var o=r(e.totalField);e.total=o(t.data),e.loading=!1})}else e.result=[],e.total=0};e.more=function(){e.offset+=e.limit,i()},e.keydown=function(t){40==t.keyCode&&e.preselect<e.result.length-1?e.preselect++:38==t.keyCode&&e.preselect>0&&e.preselect--},e.keypress=function(t){13==t.keyCode&&(e.total>0&&e.query==e.lastQuery?(t.stopPropagation(),e.selectItem(e.result[e.preselect])):e.newQuery())},e.newQuery=function(){e.lastQuery=e.query,e.offset=0,i()},e.open=function(e){window.open(e,"_blank")},e.selectItem=function(e){o.close(e)},e.$watch("titleField",function(t){t||(t="title"),e.getTitleField=r(t)})}]),angular.module("idai.components").factory("languageSelection",["language",function(e){return{__:function(t,n,r){var o=localStorage.getItem("lang");return!o||o!==COMPONENTS_GERMAN_LANG&&o!==COMPONENTS_ENGLISH_LANG?e.currentLanguage()==COMPONENTS_GERMAN_LANG?void n(COMPONENTS_GERMAN_LANG,r):void(t(e.currentLanguage(),r)?n(e.currentLanguage(),r):e.currentLanguage()==COMPONENTS_ENGLISH_LANG?n(COMPONENTS_GERMAN_LANG,r):t(COMPONENTS_ENGLISH_LANG,r)?n(COMPONENTS_ENGLISH_LANG,r):n(COMPONENTS_GERMAN_LANG,r)):void n(o,r)}}}]),angular.module("idai.components").factory("language",function(){var e=navigator.languages?navigator.languages[0]:navigator.language||navigator.userLanguage;return{originalBrowserLanguage:function(){return e},browserLanguage:function(){return this.originalBrowserLanguage().substring(0,2)},currentLanguage:function(){var e=this.browserLanguage(),t=localStorage.getItem("lang");return t&&(e=t),e}}}),angular.module("idai.components").factory("localizedContent",["languageSelection",function(e){return{reduceTitles:function(t){var n=function(e,t){t.title&&(t.title=t.title[e])},r=function(e,t){return!!t.title&&t.title[e]},o=function(t){if(e.__(r,n,t),t.children)for(var a=0;a<t.children.length;a++)o(t.children[a])};o(t)},determineLanguage:function(t,n){var r="",o=function(e,t){var r=function(t){if(t.id==n&&t.title[e])return!0;if(t.children)for(var o=0;o<t.children.length;o++)if(r(t.children[o]))return!0;return!1};return!!r(t)},a=function(e){r=e};return e.__(o,a,t),r},getNodeById:function(e,t){var n=function(e,t){if(e.id==t)return e;if(e.children){for(var r=void 0,o=0;o<e.children.length;o++){var a=n(e.children[o],t);void 0!=a&&(r=a)}return r}};return n(e,t)}}}]),angular.module("idai.components").filter("transl8Number",["language",function(e){var t=function(t){if("undefined"!=typeof t)return e.currentLanguage()==COMPONENTS_GERMAN_LANG?t.toLocaleString(COMPONENTS_GERMAN_LANG+"-DE"):t.toLocaleString(COMPONENTS_ENGLISH_LANG+"-US")};return t.$stateful=!0,t}]),angular.module("idai.components").filter("transl8",["transl8",function(e){var t=function(t){if("undefined"!=typeof t){var n;try{n=e.getTranslation(t)}catch(r){var o="TRL8 MISSING ('"+t+"')";return console.log(o),o}return n}};return t.$stateful=!0,t}]),angular.module("idai.components").factory("transl8",["$http","$location","language","componentsSettings",function(e,t,n,r){var o=n.currentLanguage(),a=!1,i={};["de","en"].indexOf(o)===-1&&(o="en");var l=r.transl8Uri.replace("{LANG}",o),c=e.jsonp(l).success(function(e){for(var t=0;t<e.length;t++)i[e[t].key]=e[t].value;a=!0}).error(function(){alert("ERROR: Could not get translations. Try to reload the page or send a mail to arachne@uni-koeln.de")});return{getTranslation:function(e){if(!a)return"";var t=i[e];if(!t||0===t.length)throw new Error("No translation found for key '"+e+"'");return t},onLoaded:function(){return c}}}]),angular.module("idai.components").factory("header",function(){}),angular.module("idai.components").directive("idaiFooter",function(){return{restrict:"E",scope:{institutions:"=",version:"@"},transclude:!0,templateUrl:"layout/idai-footer.html",controller:["$scope","$http","$sce","localizedContent","$transclude","componentsSettings",function(e,t,n,r,o,a){e.mailto=a.mailTo,o(function(t){e.hasTranscludedContent=t.length>0}),e.date=new Date,e.getFooterLinks=function(n){var o="info/content.json";t.get(o).then(function(t){var n=r.getNodeById(t.data,"footer");n?(r.reduceTitles(n),e.dynamicLinkList=n.children):console.error("error: no footer links found in file "+o)},function(e){console.error(e.data)})}}],link:function(e,t,n){e.getFooterLinks(n.contentDir)}}}),angular.module("idai.components").directive("idaiForm",function(){return{restrict:"E",transclude:!0,scope:{submit:"&",doc:"="},templateUrl:"layout/idai-form.html",link:function(e,t,n){e.reset=function(){e.doc={}}}}}),angular.module("idai.components").directive("idaiHeader",function(){return{restrict:"E",scope:{image:"@",description:"@",link:"@"},templateUrl:"layout/idai-header.html"}}),angular.module("idai.components").directive("idaiNavbar",function(){return{restrict:"E",scope:{userObject:"=",loginFunction:"&",logoutFunction:"&",hideSearchForm:"=",hideRegisterButton:"=",hideContactButton:"=",hideLanguageSwitcher:"=",projectId:"@"},templateUrl:"layout/idai-navbar.html",transclude:!0,controller:["$scope","$http","localizedContent","$location","$window",function(e,t,n,r,o){e.langCode=localStorage.getItem("lang"),e.getNavbarLinks=function(r){var o="info/content.json";t.get(o).then(function(t){var r=n.getNodeById(t.data,"navbar");r?(n.reduceTitles(r),e.dynamicLinkList=r.children):console.error("error: no navbar links found in file "+o)},function(e){console.error(e.data)})},e.toggleNavbar=function(){e.isCollapsed=!0,e.$on("$routeChangeSuccess",function(){e.isCollapsed=!0})},e.switchLanguage=function(e){localStorage.setItem("lang",e),o.location.reload()}}],link:function(e,t,n){e.getNavbarLinks(n.contentDir)}}}),angular.module("idai.components").directive("includeReplace",function(){return{require:"ngInclude",restrict:"A",link:function(e,t,n){t.replaceWith(t.children())}}}),angular.module("idai.components").component("idaiMessages",{restrict:"E",templateUrl:"messages/idai-messages.html",controller:["$scope","messageService",function(e,t){e.messages=t.all(),e.remove=function(e){t.remove(e)}}]}),angular.module("idai.components").factory("messageService",["$rootScope","transl8","$sce","componentsSettings",function(e,t,n,r){function o(e){this.text=t.getTranslation(e),this.text=n.trustAsHtml(this.text),this.level="warning",this.contactInfo=t.getTranslation("components.message.contact").replace("CONTACT",r.mailTo)}function a(e){return["success","info","warning","danger"].indexOf(e)===-1}function i(){angular.forEach(c,function(e,t){delete c[t]})}function l(e){return c[e]=new o(e),c[e]}var c={},u=!0;return e.$on("$locationChangeSuccess",function(){u&&i(),u=!0}),t.onLoaded().then(function(){angular.forEach(c,function(e,r){e.text=t.getTranslation(r),e.text=n.trustAsHtml(e.text)})}),{dontClearOnNextLocationChange:function(){u=!1},add:function(e,t,n){var r=l(e);if(t){if(a(t))throw new Error("If used, level must be set to an allowed value.");r.level=t}0!=n&&"success"!=r.level||delete r.contactInfo},remove:function(e){delete c[e]},clear:function(){i()},all:function(){return c}}}]);